const config = {
	markets: {
		name: 'Markets',
		items: {
			fan: {
				name: 'Fan tokens',
				value: 0
			},
			staking: {
				name: 'Staking',
				value: 0
			},
			btc: {
				name: 'BTC Pairs',
				value: 0
			},
			eth: {
				name: 'ETH Pairs',
				value: 0
			},
			cmc: {
				name: 'Top 10 cmc pairs',
				value: 0
			},
			gamefi: {
				name: 'GameFi tokens',
				value: 0
			},
			defi20: {
				name: 'Defi2.0 tokens',
				value: 0
			},
			socialfi: {
				name: 'SocialFi tokens',
				value: 0
			},
			meme: {
				name: 'Meme coins',
				value: 0
			},
			shit: {
				name: 'Shit coins',
				value: 0
			},
			x10: {
				name: 'Margin trading x10'
			},
			x20: {
				name: 'Margin trading x20'
			},
			x30: {
				name: 'Margin trading x30'
			},
			x50: {
				name: 'Margin trading x50'
			},
			x75: {
				name: 'Margin trading x75'
			},
			x100: {
				name: 'Margin trading x100'
			},
			derivatives: {
				name: 'Derivatives'
			},
			pmarkets: {
				name: 'Prediction markets'
			},
			web3: {
				name: 'Web3 integration'
			},
			dao: {
				name: 'DAO'
			},
			p2p: {
				name: 'P2P trading'
			},
			bots: {
				name: 'Trading bots'
			}
		}
	},
	pr: {
		name: 'PR&Team',
		items: {
			support: {
				name: 'Support team',
				value: 0
			},
			hb: {
				name: 'HamsterBook',
				value: 0
			},
			x: {
				name: 'X',
				value: 0
			},
			cointelegraph: {
				name: 'Cointelegraph',
				value: 0
			},
			ht: {
				name: 'HamsterTube',
				value: 0
			},
			hg: {
				name: 'HamsterGram',
				value: 0
			},
			tiktok: {
				name: 'TikTok',
				value: 0
			},
			coindesk: {
				name: 'Coindesk',
				value: 0
			},
			influencers: {
				name: 'Influencers',
				value: 0
			},
			ceo: {
				name: 'CEO',
				value: 0
			},
			it: {
				name: 'IT team',
				value: 0
			},
			marketing: {
				name: 'Marketing',
				value: 0
			},
			partnership: {
				name: 'Partnership program',
				value: 0
			},
			pt: {
				name: 'Product team',
				value: 0
			},
			bigdev: {
				name: 'BisDev team',
				value: 0
			},
			f2a: {
				name: 'Two factor authentication'
			},
			uxui: {
				name: 'UX and UI team'
			},
			security: {
				name: 'Security team',
			},
			qa: {
				name: 'QA team'
			},
			shield: {
				name: 'Antihacking shield',
			},
			risk: {
				name: 'Risk management team'
			},
			audit: {
				name: 'Security Audition'
			},
			txban: {
				name: 'Anonymous transactions ban'
			},
			block: {
				name: 'Blocking suspicious accounts'
			},
			tokenomics: {
				name: 'Tokenomics expert'
			},
			exppass: {
				name: 'Consensus Explorer pass'
			},
			vc: {
				name: 'VS labs'
			},
			officer: {
				name: 'Compliance officer'
			},
			wmas: {
				name: 'Welcome to Amsterdam'
			}
		}
	},
	legal: {
		name: 'Legal',
		items: {
			kyc: {
				name: 'KYC',
				value: 0
			},
			kyb: {
				name: 'KYB',
				value: 0
			},
			legal: {
				name: 'Legal opinion',
				value: 0
			},
			sec: {
				name: 'SEC transparency',
				value: 0
			},
			aml: {
				name: 'Anti money loundering',
				value: 0
			},
			luae: {
				name: 'License UAE',
				value: 0
			},
			leu: {
				name: 'License Europe',
				value: 0
			},
			lasia: {
				name: 'License Asia',
				value: 0
			},
			lsa: {
				name: 'License South America',
				value: 0
			},
			lau: {
				name: 'License Australia',
				value: 0
			},
			lna: {
				name: 'License North America',
				value: 0
			},
			ln: {
				name: 'License Nigeria'
			},
			ljp: {
				name: 'License Japan'
			},
			leth: {
				name: 'License Ethiopia'
			},
			lindia: {
				name: 'License India'
			},
			lbangladesh: {
				name: 'License Bangladesh'
			}
		}
	},
	specials: {
		name: 'Specials',
		items: {
			tonusdt: {
				name: 'USDT on TON'
			},
			bogdanoff: {
				name: 'Bogdanoff is calling'
			},
			appscl: {
				name: 'Apps Center Listing'
			},
			villa: {
				name: 'Villa for the DEV team'
			},
			long: {
				name: 'Long squeeze'
			},
			short: {
				name: 'Short squeeze',
			},
			adc: {
				name: 'Ad contract with football club'
			},
			conference: {
				name: 'Special Hamster Conference'
			},
			twochairs: {
				name: 'There are two chairs...'
			},
			/*venom: {
				name: 'Venom Blockchain',
			},*/
			top10: {
				name: 'Top 10 Global Ranking'
			},
			nftl: {
				name: 'NFT Collection Launch'
			},
			tonham: {
				name: 'TON + Hamster Kombat = Success'
			},
			piranha: {
				name: 'Consensus Piranha Pass'
			},
			web3a: {
				name: 'Web3 academy launch'
			},
			ytbutton: {
				name: 'YouTube Gold Button'
			},
			ytchannel: {
				name: 'Hamster YouTube Channel'
			},
			/*dshow: {
				name: 'Hamster daily show'
			},*/
			/*ceosgz: {
				name: '21.000.000 CEOs'
			},*/
			pizza: {
				name: 'Bitcoin Pizza Day'
			},
			/*ai: {
				name: 'Hamster AI'
			}*/
			merch: {
				name: 'Hamster Kombat Merch'
			},
			premarket: {
				name: 'Premarket Launch'
			}
		}
	}
};

const formatter = Intl.NumberFormat('en', { notation: 'compact' });
const dump = document.querySelector('textarea[name="dump"]');

dump.value = localStorage.getItem('dump')?.length ? localStorage.getItem('dump') : '';

const boot = () => {
	const saved = dump.value.length ? JSON.parse(dump.value) : {};
	const daily = localStorage.getItem('daily')?.length ? JSON.parse(localStorage.getItem('daily')) : [];

	for(const key in config) {
		const $template = document.createElement('template');

		$template.innerHTML = `<div class="category" data-key><div class="name"></div><div class="items"></div></div>`;
		$template.content.querySelector('.category').dataset.key = key;
		$template.content.querySelector('.name').innerText = config[key].name;

		document.querySelector('.calculator .categories').append($template.content);

		const $items = document.querySelector(`.categories .category[data-key="${key}"] .items`);

		for(const k in config[key].items) {
			const i = config[key].items[k];
			const isDaily = daily.findIndex((item) => item[0] === key && item[1] === k) > -1;

			const cost = key in saved && k in saved[key] ? saved[key][k][0] : 0;
			const profit = key in saved && k in saved[key] ? saved[key][k][1] : 0;

			$items.insertAdjacentHTML(
				'beforeend',
				`<div class="item${isDaily ? ' daily' : ''}" data-key="${k}">
                    <div class="name">${i.name}</div>
                    <div class="opinions">
						<div>
							<label>Upgrade cost</label>
							<input type="number" name="cost" value="${cost}" onkeyup="update();calculate()" onchange="update();calculate()" pattern="[0-9]*" inputmode="numeric" />
						</div>
						<div>
							<label>Profit/hour</label>
							<input type="number" name="profit" value="${profit}" onkeyup="update();calculate()" onchange="update();calculate()" pattern="[0-9]*" inputmode="numeric" />
						</div>
					</div>
					<!--div class="daily">
						<span onclick="markAsDaily(this);">${isDaily ? 'is not' : 'is'} daily</span>
					</div-->
                </div>`
			);
		}
	}

	calculate();
};

const update = () => {
	const saved = {};

	document.querySelectorAll('.calculator .categories .category').forEach((element) => {
		saved[element.dataset.key] = {};

		element.querySelectorAll('.items .item').forEach((el) => {
			saved[element.dataset.key][el.dataset.key] = [
				Number(el.querySelector('[name="cost"]').value || 0), Number(el.querySelector('[name="profit"]').value || 0)
			];
		});
	});

	dump.value = JSON.stringify(saved);
	store();
};

const calculate = () => {
	const best = {
		first: null,
		second: null,
		third: null
	};

	const keys = Object.keys(best);

	let total = 0;

	/*const daily = {
		isBetter: false,
		saved: !localStorage.getItem('daily')?.length
			? []
			: JSON.parse(localStorage.getItem('daily')).map((item) => {
				return {
					category: item[0],
					item: item[1],
					cost: 0,
					profit: 0
				};
			}),
	};*/

	document.querySelectorAll('.calculator .categories .category').forEach((element) => {
		element.querySelectorAll('.items .item').forEach((el) => {
			const cost = Number(el.querySelector('[name="cost"]').value);
			const profit = Number(el.querySelector('[name="profit"]').value);

			/*const dailyIndex = daily.saved.findIndex((item) => item.category === element.dataset.key && item.item === el.dataset.key);

			if(dailyIndex > -1) {
				daily.saved[dailyIndex].cost = cost;
				daily.saved[dailyIndex].profit = profit;
			}*/

			/*if((!best.first || best.first.value < profit / cost) && cost > 0 && profit > 0) {
				best.third = best.second;
				best.second = best.first;

				best.first = {
					category: element.dataset.key,
					item: el.dataset.key,
					value: profit > 0 ? profit / cost : 0,
					cost, profit
				};
			}*/

			for(let i = 0; i < keys.length; i++) {
				const key = keys[i];

				if((!best[key] || best[key].value < profit / cost) && cost > 0 && profit > 0) {
					for(let l = keys.length - 1; l > i + 1; l--) {
						best[keys[l]] = best[keys[l - 1]];
					}

					const value = profit > 0 ? profit / cost : 0;

					total += value;

					best[key] = {
						category: element.dataset.key,
						item: el.dataset.key,
						value, cost, profit
					};

					break;
				}
			}
		});
	});

	if(best.first) {
		/*if(daily.saved.length === 3) {
			const dailyTotal = daily.saved.reduce((value, item) => {
				return item.profit + value;
			}, 0) / (daily.saved.reduce((value, item) => {
				return item.cost + value;
			}, 0) - 5_000_000);

			const bestTotal = Object.values(best).reduce((value, item) => {
				return item.value + value;
			}, 0);

			daily.isBetter = dailyTotal > bestTotal;

			if(daily.isBetter) {
				[best.first, best.second, best.third] = daily.saved;
			}
		}

		console.log(daily);*/


		document.querySelectorAll('.calculator .categories .category .items .item.best').forEach((el) => el.classList.remove('best'));

		//const total = Object.values(best).reduce((value, item) => value + (item?.value || 0), 0);
		const text = [];

		for(const [key, value] of Object.entries(best)) {
			if(value !== null) {
				const percent = Math.round(value.value / total * 10000) / 100;

				text.push(`<div>${config[value.category].items[value.item].name} in ${config[value.category].name} (${formatter.format(value.profit)} per hour for ${formatter.format(value.cost)}) - ${percent}%</div>`);
				document.querySelector(`.calculator .categories .category[data-key="${value.category}"] .items .item[data-key="${value.item}"]`).classList.add('best');
			}
		}

		document.querySelector('.results').innerHTML = text.join('\n');

		return;
	}

	document.querySelector('.results').innerText = `Fill data before start`;
};

const fill = () => {
	const saved = dump.value.length ? JSON.parse(dump.value) : {};

	document.querySelectorAll('.calculator .categories .category').forEach((element) => {
		element.querySelectorAll('.items .item').forEach((el) => {
			el.querySelector('[name="cost"]').value = element.dataset.key in saved && el.dataset.key in saved[element.dataset.key] ? saved[element.dataset.key][el.dataset.key][0] : 0;
			el.querySelector('[name="profit"]').value = element.dataset.key in saved && el.dataset.key in saved[element.dataset.key] ? saved[element.dataset.key][el.dataset.key][1] : 0;
		});
	});

	store();
	calculate();
}

const store = () => {
	if(!dump.value.length) {
		localStorage.removeItem('dump');
		return;
	}

	try {
		if(Object.prototype.toString.call(JSON.parse(dump.value)) === '[object Object]') {
			localStorage.setItem('dump', dump.value);
		}
	}
	catch(e) {
		console.error(e.message);
	}
}

const markAsDaily = (element) => {
	let cached = localStorage.getItem('daily')?.length ? JSON.parse(localStorage.getItem('daily')) : [];

	const keys = [
		element.parentElement.parentElement.parentElement.parentElement.dataset.key, element.parentElement.parentElement.dataset.key
	];

	const index = cached.findIndex((item) => item[0] === keys[0] && item[1] === keys[1]);

	if(index > -1) {
		delete cached[index];
		cached = cached.filter(Boolean);

		document.querySelector(`.calculator .categories .category[data-key="${keys[0]}"] .items .item[data-key="${keys[1]}"]`).classList.remove('daily');
		document.querySelector(`.calculator .categories .category[data-key="${keys[0]}"] .items .item[data-key="${keys[1]}"] .daily > span`).innerText = 'is daily';
	}
	else {
		document.querySelectorAll('.calculator .categories .category .items .item.daily').forEach((el) => el.classList.remove('daily'));

		if(cached.length >= 3) {
			const first = cached.shift();

			document.querySelector(`.calculator .categories .category[data-key="${first[0]}"] .items .item[data-key="${first[1]}"]`).classList.remove('daily');
			document.querySelector(`.calculator .categories .category[data-key="${first[0]}"] .items .item[data-key="${first[1]}"] .daily > span`).innerText = 'is daily';
		}

		cached.push(keys);

		cached.forEach((item) => {
			document.querySelector(`.calculator .categories .category[data-key="${item[0]}"] .items .item[data-key="${item[1]}"]`).classList.add('daily');
			document.querySelector(`.calculator .categories .category[data-key="${item[0]}"] .items .item[data-key="${item[1]}"] .daily > span`).innerText = 'is not daily';
		});
	}

	localStorage.setItem('daily', JSON.stringify(cached));

	calculate();
};

const roundToFirstNumber = (number) => {

	for(let i = 1; i <= number.toString().length; i++) {
		const str = number.toString().substring(0, i);

		if(!str.endsWith('.') && !str.endsWith('0')) {
			return str;
		}
	}

	return number.toString();
};

document.addEventListener('DOMContentLoaded', boot);